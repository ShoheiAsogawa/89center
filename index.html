<!DOCTYPE html><html lang="ja"><head> 
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>89CENTERäºˆç´„ãƒšãƒ¼ã‚¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg: #f7f9fc;
    --card: #ffffff;
    --card-2:#f3f4f6;
    --text: #111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --orange:#fb923c;
    --orange-dark:#f97316;
    --danger:#ef4444;
    --gray:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
  .container{max-width:1000px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 0;position:relative}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.02em}
  .datebar{display:flex;align-items:center;justify-content:center;margin:8px 0 12px}
  .date-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:16px;background:#fff;font-weight:700}
  .date-pill button{border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer}
  .btn{border:1px solid var(--border);background:#fff;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .06s ease, filter .12s ease, background-color .12s ease}
  .btn:active{transform:translateY(1px);filter:brightness(.92)}
  .btn-primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn-orange{background:var(--orange);border-color:transparent;color:#fff;font-weight:800;border-radius:14px}
  .btn-orange:active{background:var(--orange-dark)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .grid{overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  th:first-child, td:first-child{position:sticky;left:0;background:#fff;z-index:3}
  th:first-child{z-index:4}
  th{background:var(--card-2);font-weight:700}
  thead th{position:sticky;top:0;z-index:5}
  th,td{padding:8px;min-width:90px;text-align:center}
  td.time{background:var(--card-2);font-weight:700;min-width:64px}
  td.available{background:#fff;cursor:pointer}
  td.booked{background:var(--gray);color:#374151}
  td.own{background:var(--orange);color:#fff}
  .caption{color:var(--muted);font-size:12px}
  
  /* Legend chips */
  .legend{display:flex;align-items:center;justify-content:center;gap:14px;margin:6px 0 10px}
  .legend .chip{display:inline-flex;align-items:center;gap:8px}
  .legend .dot{width:16px;height:16px;border-radius:6px;border:1px solid var(--border)}
  .legend .dot.own{background:var(--orange);border-color:transparent}
  .legend .dot.booked{background:var(--gray)}
  
  /* overlays */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40;padding:16px}
  .modal{position:relative;width:min(92vw,520px);background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.12)}
  .modal h2{margin:0 0 12px}
  .modal-close{position:absolute;right:8px;top:8px;width:34px;height:34px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;line-height:1;font-weight:900;transition:transform .06s ease, filter .12s ease}
  .modal-close:active{transform:translateY(1px);filter:brightness(.92)}
  .row{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .input,.select,.textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .textarea{min-height:96px;resize:vertical}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  
  /* Calendar popup (header sticky) */
  .cal-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 10px;position:sticky;top:0;background:#fff;z-index:2;padding-bottom:6px}
  .cal-nav{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:700;transition:transform .06s ease, filter .12s ease}
  .cal-nav:active{transform:translateY(1px);filter:brightness(.92)}
  .cal-title{font-weight:700;font-size:16px}
  .cal-grid{display:grid;grid-template-columns: repeat(7, 1fr); gap:6px; width:100%}
  .cal-cell{height:42px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;transition:transform .06s ease, filter .12s ease}
  .cal-cell:active{transform:translateY(1px);filter:brightness(.92)}
  .cal-dow{background:var(--card-2);color:#4b5563;border-style:dashed;height:36px;font-weight:700}
  .is-disabled{opacity:.4;pointer-events:none}
  .is-today{outline:2px solid var(--primary);outline-offset:2px}
  .is-selected{background:var(--primary);color:#fff;border-color:transparent}
  
  /* toasts & confirm */
  .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;display:flex;flex-direction:column;gap:8px;z-index:50}
  .toast{padding:12px 16px;border-radius:12px;background:#111827;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.2);font-weight:600}
  .toast.ok{background:#16a34a}.toast.err{background:#ef4444}
  
  /* Loading overlay */
  .loading-overlay{position:fixed;inset:0;background:rgba(55,65,81,.9);display:none;align-items:center;justify-content:center;z-index:70}
  .loading-box{text-align:center;color:#fff}
  .loading-title{font-weight:800;font-size:20px;letter-spacing:.08em;display:flex;align-items:center;justify-content:center;gap:8px}
  .loading-dot{display:inline-block;min-width:24px;text-align:right;font-weight:900}
  .loading-sub{margin-top:10px;font-weight:700;opacity:.95}
  
  /* tabs for terms */
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  .terms-box{height:220px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .terms-box h3{margin:0 0 10px;font-size:15px}
  .terms-box p{margin:0 0 10px;font-size:13px;line-height:1.7}
  
  /* summary */
  .summary{background:var(--card-2);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:6px 0 12px;text-align:left}
  .summary .kv{display:flex;gap:10px;align-items:center;margin:4px 0}
  .summary .kv .k{width:64px;color:var(--muted);font-size:12px}
  .summary .kv .v{font-weight:600}
  .link{background:none;border:none;padding:0;font:inherit;color:var(--primary);text-decoration:underline;cursor:pointer}
  .hdr-right{position:absolute;right:0;top:0;display:flex;gap:8px}
  
  /* Complete modal visual */
  .complete .success-ico{width:56px;height:56px;border-radius:50%;background:var(--orange);color:#fff;display:flex;align-items:center;justify-content:center;margin:6px auto 8px;font-weight:900;font-size:28px;box-shadow:0 6px 18px rgba(251,146,60,.35)}
  .complete h2{font-size:20px;font-weight:800;margin:6px 0 10px;text-align:center}
  .complete .result-body{margin:8px auto 14px;text-align:left;max-width:360px}
  .complete .result-body .rowline{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--card-2);margin:6px 0;font-weight:600}
  
  /* Button loading spinner ------------------------- */
  .btn{ position: relative; }
  .btn .btn-label{ pointer-events:none; }
  .btn .spinner{
    display:none; width:16px; height:16px;
    border:2px solid currentColor;      /* ãƒœã‚¿ãƒ³æ–‡å­—è‰²ã«è¿½å¾“ã€‚ã‚ªãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³ã¯ç™½ã«ãªã‚Šã¾ã™ */
    border-top-color: transparent;
    border-radius:50%;
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    animation: btnspin .8s linear infinite;
  }
  .btn.is-loading .spinner{ display:block; }
  .btn.is-loading .btn-label{ visibility:hidden; }
  .btn.is-loading, .btn:disabled{ pointer-events:none; opacity:.9; filter:brightness(.95); }
  
  @keyframes btnspin{
    0%   { transform: translate(-50%,-50%) rotate(0deg); }
    100% { transform: translate(-50%,-50%) rotate(360deg); }
  }
  
  </style>
  </head><body>
  <div class="container">
    <header>
      <h1>89CENTER äºˆç´„</h1>
      <div class="hdr-right"><button class="btn" id="btnTerms">ã”åˆ©ç”¨æ¡ä»¶</button></div>
    </header>
  
    <div class="datebar">
      <div class="date-pill">
        <button id="prevDay" aria-label="å‰æ—¥">â€¹</button>
        <div id="dateLabel"></div>
        <button id="openCal" aria-label="æ—¥ä»˜é¸æŠ">ğŸ“…</button>
        <button id="nextDay" aria-label="ç¿Œæ—¥">â€º</button>
      </div>
    </div>
  
    <!-- legend -->
    <div class="legend">
      <span class="chip"><i class="dot own"></i><span class="caption">ã‚ãªãŸã®äºˆç´„</span></span>
      <span class="chip"><i class="dot booked"></i><span class="caption">äºˆç´„æ¸ˆã¿</span></span>
      <span class="caption">(60åˆ†æ )</span>
    </div>
  
    <div class="card grid"><table id="table">
      <thead><tr><th style="min-width:70px">æ™‚é–“</th><th>éº»ç”Ÿå·</th><th>å²¡é‡</th><th>å €æ±Ÿ</th><th>æ¾ç”°</th><th>å±±å£</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table></div>
  </div>
  
  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
      <div class="loading-title">
    ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ <span class="loading-dot" id="loadingDots">ãƒ»</span>
    </div>
  
      <div class="loading-sub">89CENTER</div>
    </div>
  </div>
  
  <!-- Complete modal -->
  <div class="overlay" id="completeOverlay" role="dialog" aria-modal="true">
    <div class="modal complete" style="text-align:center">
      <button class="modal-close" id="completeCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <div class="success-ico">âœ“</div>
      <h2>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
      <div class="result-body" id="completeBody"></div>
      <div class="actions" style="justify-content:center">
    <button class="btn" id="completeClose">é–‰ã˜ã‚‹</button>
    </div>
  
    </div>
  </div>
  
  <!-- Booking modal -->
  <div class="overlay" id="bookOverlay" role="dialog" aria-modal="true">
    <div class="modal" style="text-align:center">
      <button class="modal-close" id="closeBookX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <h2>äºˆç´„å†…å®¹ã®å…¥åŠ›</h2>
      <div id="bookSummary" class="summary">
        <div class="kv"><span class="k">æ—¥ä»˜</span><span class="v" id="sumDate">â€”</span></div>
        <div class="kv"><span class="k">ã‚¹ã‚¿ãƒƒãƒ•</span><span class="v" id="sumStaff">â€”</span></div>
        <div class="kv"><span class="k">æ™‚é–“</span><span class="v" id="sumTime">â€”</span></div>
      </div>
  
      <div class="row">
        <div class="field"><input id="pName" class="input" placeholder="ãŠåå‰"></div>
        <div class="field"><input id="pPhone" class="input" placeholder="é›»è©±"></div>
        <div class="field"><textarea id="pSymptoms" class="textarea" placeholder="ç—‡çŠ¶ï¼ˆä»»æ„ï¼‰"></textarea></div>
      </div>
      <div class="caption">å†…å®¹ã®å‰ã« <button class="link" type="button" id="openTermsInline">ã”åˆ©ç”¨æ¡ä»¶</button> ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>
      <div class="row" style="align-items:center">
        <label style="display:flex;gap:8px;align-items:center;justify-content:center;width:100%">
          <input type="checkbox" id="agreeAll"> ä¸Šè¨˜ã®å†…å®¹ã«åŒæ„ã—ã¾ã™
        </label>
      </div>
      <div class="actions" style="justify-content:center">
        <button class="btn" id="closeBook">é–‰ã˜ã‚‹</button>
        <button class="btn btn-orange" id="doBook">
    <span class="btn-label">äºˆç´„ã™ã‚‹</span>
    <span class="spinner" aria-hidden="true"></span>
  </button>
  
      </div>
    </div>
  </div>
  
  <!-- Terms modal -->
  <div class="overlay" id="termsOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="modal-close" id="termsCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <div class="tabs">
        <button class="tab active" id="tabTos">åˆ©ç”¨è¦ç´„</button>
        <button class="tab" id="tabPriv">å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„</button>
      </div>
      <div class="terms-box" id="termsBox"><h3>åˆ©ç”¨è¦ç´„</h3>
  <p>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€89CENTERï¼ˆä»¥ä¸‹ã€Œå½“é™¢ã€ï¼‰ãŒæä¾›ã™ã‚‹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚æ‚£è€…ã•ã¾ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã®ã†ãˆã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
  <p>1. äºˆç´„ã¯30åˆ†å˜ä½ã®æ ã‚’ç”¨ã„ã¾ã™ãŒã€æ–½è¡“ã¯60åˆ†å˜ä½ã§ã™ã€‚<br>
  2. å½“æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãŠé›»è©±ã®ã¿å¯¾å¿œã—ã¾ã™ã€‚ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒç¶šãå ´åˆã€ä»¥å¾Œã®ã”äºˆç´„ã‚’ãŠæ–­ã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
  3. äºˆç´„å†…å®¹ã«è™šå½ãŒåˆ¤æ˜ã—ãŸå ´åˆã€å½“é™¢ã¯äºˆç´„ã‚’å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã™ã€‚<br>
  4. å¤©ç½ãƒ»ã‚·ã‚¹ãƒ†ãƒ éšœå®³ç­‰ã«ã‚ˆã‚Šäºˆç´„ãŒæˆç«‹ã—ãªã„ã€ã¾ãŸã¯å¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
  5. æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«é–¢é€£ã—ã¦ç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦ã€å½“é™¢ã¯ç›´æ¥çš„ã‹ã¤é€šå¸¸ã®ç¯„å›²å†…ã§ã®ã¿è²¬ä»»ã‚’è² ã„ã¾ã™ã€‚</p>
  <p>æœ€çµ‚æ›´æ–°æ—¥ï¼š2025å¹´8æœˆ</p></div>
      <div class="actions" style="justify-content:center">
        <button class="btn" id="termsClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- Calendar -->
  <div class="overlay" id="calendarOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="cal-head">
        <button class="cal-nav" id="calPrev">â€¹</button>
        <div class="cal-title" id="calTitle">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
        <button class="cal-nav" id="calNext">â€º</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="actions"><button class="btn" id="calClose">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>
  
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>
  
  <script>
    // ===== Boot strapï¼ˆå˜ä¸€ã®çœŸå®Ÿï¼‰=====
    const ALLOWED_ORIGINS = new Set([
      'https://liff.line.me',
      'https://89center.net',
      'https://www.89center.net',
      'https://89center.studio.site' // å¿…è¦ãªã‚‰
    ]);
  
    let ID_TOKEN = null;   // â† 1å›ã ã‘
    let USER_ID  = (()=>{  // â† 1å›ã ã‘ï¼ˆéå»ä¿å­˜ãŒã‚ã‚Œã°æ‹¾ã†ï¼‰
      try { return localStorage.getItem('LINE_UID') || ''; } catch { return ''; }
    })();

    // --- ãƒ˜ãƒ«ãƒ‘é–¢æ•°: id_token ã‹ã‚‰ sub (LINE UID) ã‚’å–ã‚Šå‡ºã™
    function extractSubFromIdToken(token){
      try{
        const parts = String(token||'').split('.');
        if (parts.length < 2) return '';
        let base64 = parts[1].replace(/-/g,'+').replace(/_/g,'/');
        // Padding ã‚’èª¿æ•´ã™ã‚‹
        while (base64.length % 4 !== 0) base64 += '=';
        const payload = atob(base64);
        const claims = JSON.parse(payload);
        return claims.sub || '';
      }catch(e){
        return '';
      }
    }
  
    // è¦ªï¼ˆSTUDIOï¼‰ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã¯ã“ã‚Œ1æœ¬ã«çµ±åˆ
    window.addEventListener('message', (e) => {
      if (!ALLOWED_ORIGINS.has(e.origin)) return;
      const d = e.data || {};
  
      if (d.type === 'ID_TOKEN' && d.idToken){
        ID_TOKEN = d.idToken;
        // id_token ã‹ã‚‰ UID ã‚’å–ã‚Šå‡ºã›ã‚‹å ´åˆã¯ä¿å­˜
        if (!USER_ID){
          const sub = extractSubFromIdToken(d.idToken);
          if (sub){
            USER_ID = sub;
            try { localStorage.setItem('LINE_UID', USER_ID); } catch {}
          }
        }
        try { load(false); } catch {}
      }
      if (d.type === 'SET_UID' && d.uid){
        USER_ID = d.uid;
        try { localStorage.setItem('LINE_UID', USER_ID); } catch {}
        if (!ID_TOKEN) try { load(false); } catch {}
      }
    });
  
  
  function setBtnLoading(target, on){
    const el = typeof target === 'string' ? document.getElementById(target) : target;
    if (!el) return;
    if (on){
      el.classList.add('is-loading');
      el.setAttribute('aria-busy','true');
      el.disabled = true;
    }else{
      el.classList.remove('is-loading');
      el.removeAttribute('aria-busy');
      el.disabled = false;
    }
  }
  
  function showToast(msg, type){ const w=document.getElementById('toastWrap'); const t=document.createElement('div'); t.className='toast '+(type||'ok'); t.textContent=msg; w.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 2200); }
  function dowJP(d){ return ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]; }
  function fmtISO(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
  function fmtJP(d){ const y=d.getFullYear(); const m=d.getMonth()+1; const dd=d.getDate(); return y+'å¹´'+('0'+m).slice(-2)+'æœˆ'+('0'+dd).slice(-2)+'æ—¥ï¼ˆ'+dowJP(d)+'ï¼‰'; }
  
  let __dotsTimer = null;
  function startDots(){ const el=document.getElementById('loadingDots'); if(!el) return; let n=1; el.textContent='ãƒ»'; clearInterval(__dotsTimer); __dotsTimer=setInterval(()=>{ n=(n%3)+1; el.textContent='ãƒ»'.repeat(n); },420); }
  function stopDots(){ if(__dotsTimer){ clearInterval(__dotsTimer); __dotsTimer=null; } const el=document.getElementById('loadingDots'); if(el) el.textContent='ãƒ»'; }
  function bindCloseX(overlayId, btnId){ const ov=document.getElementById(overlayId); const btn=document.getElementById(btnId); if(ov&&btn){ btn.onclick=()=> ov.style.display='none'; ov.addEventListener('click',e=>{ if(e.target===ov) ov.style.display='none'; }); } }
  
  const STAFF = ['éº»ç”Ÿå·','å²¡é‡','å €æ±Ÿ','æ¾ç”°','å±±å£'];
  const FEES = {'éº»ç”Ÿå·':16500,'å²¡é‡':11000,'å €æ±Ÿ':11000,'æ¾ç”°':11000,'å±±å£':11000};
  function showLoading(v){ const ov=document.getElementById('loadingOverlay'); ov.style.display=v?'flex':'none'; if(v) startDots(); else stopDots(); }
  
  let currentDate = new Date();
  const todayISO = fmtISO(new Date());
  const MIN_DATE = todayISO; // éå»ã‚’ç¦æ­¢
  let schedule = {}, pending={};
  
  function setDate(d){ currentDate=d; document.getElementById('dateLabel').textContent = fmtJP(currentDate); }
  function shiftDate(days){ const d=new Date(currentDate); d.setDate(d.getDate()+days); if (fmtISO(d) < MIN_DATE) return; setDate(d); load(true); }
  
  function renderTable(){
    const tbody=document.getElementById('tbody'); tbody.innerHTML='';
    const times = []; for (let h=9;h<21;h++) for (let m of [0,30]) times.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2)); 
    times.forEach(t=>{ const tr=document.createElement('tr'); const timeTd=document.createElement('td'); timeTd.className='time'; timeTd.textContent=t; tr.appendChild(timeTd);
      STAFF.forEach(s=>{ const td=document.createElement('td'); const slot=(schedule[s]&&schedule[s][t])||null;
        if (!slot || t==='21:00' || t>='20:30' || (slot && (slot.blocked))){ td.className='booked'; }
        else if (slot.booked && slot.own) { td.className='own'; td.onclick=()=>openOwnDetail(s,t); }
        else if (slot.booked) { td.className='booked'; }
        else { td.className='available'; td.onclick=()=>tryStartBooking(s,t); }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
  
  function tryStartBooking(staff, time){
    const cur = schedule[staff][time];
    const hh=parseInt(time.slice(0,2)), mm=parseInt(time.slice(3));
    const next = (new Date(0,0,0,hh,mm+30)).toTimeString().slice(0,5);
    const end = (new Date(0,0,0,hh,mm+60)).toTimeString().slice(0,5);
    const nxt = schedule[staff][next];
    if (!cur || !nxt || cur.booked || cur.blocked || nxt.booked || nxt.blocked || time>='20:30') { showToast('60åˆ†æ ãŒç¢ºä¿ã§ãã¾ã›ã‚“ã€‚åˆ¥ã®æ™‚é–“ã‚’ãŠé¸ã³ãã ã•ã„ã€‚','err'); return; }
    pending={staff, time, next, end};
    document.getElementById('sumStaff').textContent = staff;
    document.getElementById('sumTime').textContent = time+'ã€œ'+end;
    document.getElementById('sumDate').textContent = fmtJP(currentDate);
    document.getElementById('bookOverlay').style.display='flex';
  }
  function openOwnDetail(){ showToast('ã”è‡ªèº«ã®äºˆç´„æ ã§ã™ã€‚'); }
  
  function load(withLoader){
    const iso = fmtISO(currentDate);
    if (withLoader) showLoading(true);
  
    const ok = (res) => { schedule = res; renderTable(); if (withLoader) showLoading(false); };
    const ng = (e)  => { if (withLoader) showLoading(false); showToast('ã‚¨ãƒ©ãƒ¼: '+ e.message, 'err'); };
  
    if (ID_TOKEN){
      google.script.run.withSuccessHandler(ok).withFailureHandler(ng)
        .getScheduleWithToken(iso, ID_TOKEN);
    }else{
      google.script.run.withSuccessHandler(ok).withFailureHandler(ng)
        .getSchedule(iso, false, USER_ID || '');
    }
  }
  
  
  
  /* ---- Terms tab contents ---- */
  const TOS_HTML = `
    <h3>åˆ©ç”¨è¦ç´„</h3>
    <p>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€89CENTERï¼ˆä»¥ä¸‹ã€Œå½“é™¢ã€ï¼‰ãŒæä¾›ã™ã‚‹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚æ‚£è€…ã•ã¾ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã®ã†ãˆã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
    <p>1. äºˆç´„ã¯30åˆ†å˜ä½ã®æ ã‚’ç”¨ã„ã¾ã™ãŒã€æ–½è¡“ã¯60åˆ†å˜ä½ã§ã™ã€‚<br>
       2. å½“æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãŠé›»è©±ã®ã¿å¯¾å¿œã—ã¾ã™ã€‚ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒç¶šãå ´åˆã€ä»¥å¾Œã®ã”äºˆç´„ã‚’ãŠæ–­ã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
       3. äºˆç´„å†…å®¹ã«è™šå½ãŒåˆ¤æ˜ã—ãŸå ´åˆã€å½“é™¢ã¯äºˆç´„ã‚’å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã™ã€‚<br>
       4. å¤©ç½ãƒ»ã‚·ã‚¹ãƒ†ãƒ éšœå®³ç­‰ã«ã‚ˆã‚Šäºˆç´„ãŒæˆç«‹ã—ãªã„ã€ã¾ãŸã¯å¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
       5. æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«é–¢é€£ã—ã¦ç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦ã€å½“é™¢ã¯ç›´æ¥çš„ã‹ã¤é€šå¸¸ã®ç¯„å›²å†…ã§ã®ã¿è²¬ä»»ã‚’è² ã„ã¾ã™ã€‚</p>
    <p>æœ€çµ‚æ›´æ–°æ—¥ï¼š2025å¹´8æœˆ</p>
  `;
  
  const PRIV_HTML = `
    <h3>å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„</h3>
    <p>å½“é™¢ã¯ã€äºˆç´„ç®¡ç†ãƒ»é€£çµ¡ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®ãŸã‚ã«ã€æ°åãƒ»é›»è©±ç•ªå·ãƒ»ï¼ˆä»»æ„ã®ï¼‰ç—‡çŠ¶ç­‰ã®å€‹äººæƒ…å ±ã‚’å–å¾—ãƒ»åˆ©ç”¨ã—ã¾ã™ã€‚</p>
    <p>ã€åˆ©ç”¨ç›®çš„ã€‘äºˆç´„ã®å—ä»˜ãƒ»å¤‰æ›´ãƒ»é€£çµ¡ã€ãƒªãƒã‚¤ãƒ³ãƒ‰é…ä¿¡ã€æ¥é™¢æ™‚ã®æœ¬äººç¢ºèªã€å††æ»‘ãªæ–½è¡“æä¾›ã€‚</p>
    <p>ã€ç¬¬ä¸‰è€…æä¾›ã€‘æ³•ä»¤ã«åŸºã¥ãå ´åˆã‚’é™¤ãã€æœ¬äººã®åŒæ„ãªãç¬¬ä¸‰è€…ã«æä¾›ã—ã¾ã›ã‚“ã€‚</p>
    <p>ã€å§”è¨—ã€‘ã‚·ã‚¹ãƒ†ãƒ é‹ç”¨ç­‰ã‚’å¤–éƒ¨ã«å§”è¨—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®éš›ã¯é©åˆ‡ã«å§”è¨—å…ˆã‚’ç›£ç£ã—ã¾ã™ã€‚</p>
    <p>ã€ä¿ç®¡æœŸé–“ã€‘ç›®çš„é”æˆã«å¿…è¦ãªæœŸé–“ä¿ç®¡ã—ã€ä¸è¦ã«ãªã£ãŸæƒ…å ±ã¯é©åˆ‡ã«å‰Šé™¤ã—ã¾ã™ã€‚</p>
    <p>ã€å®‰å…¨ç®¡ç†ã€‘ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ»æ¼ãˆã„é˜²æ­¢ã®ãŸã‚ã€å¿…è¦ã‹ã¤é©åˆ‡ãªå®‰å…¨ç®¡ç†æªç½®ã‚’è¬›ã˜ã¾ã™ã€‚</p>
    <p>ã€é–‹ç¤ºç­‰ã®è«‹æ±‚ã€‘ã”è‡ªèº«ã®æƒ…å ±ã®é–‹ç¤ºãƒ»è¨‚æ­£ãƒ»å‰Šé™¤ç­‰ã¯ã€å½“é™¢çª“å£ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</p>
    <p>ã€ãŠå•ã„åˆã‚ã›ã€‘89CENTER å€‹äººæƒ…å ±çª“å£</p>
  `;
  
  /* ã‚¿ãƒ–åˆ‡æ›¿ */
  function setTermsTab(which){
    const tosBtn = document.getElementById('tabTos');
    const privBtn = document.getElementById('tabPriv');
    const box = document.getElementById('termsBox');
    if (!tosBtn || !privBtn || !box) return;
  
    if (which === 'priv'){
      tosBtn.classList.remove('active');
      privBtn.classList.add('active');
      box.innerHTML = PRIV_HTML;
    }else{
      privBtn.classList.remove('active');
      tosBtn.classList.add('active');
      box.innerHTML = TOS_HTML;
    }
  }
  
  document.addEventListener('DOMContentLoaded', ()=>{
    setDate(new Date()); load(true);
    document.getElementById('tabTos').onclick  = () => setTermsTab('tos');
    document.getElementById('tabPriv').onclick = () => setTermsTab('priv');
    document.getElementById('prevDay').onclick=()=>shiftDate(-1);
    document.getElementById('nextDay').onclick=()=>shiftDate(1);
    document.getElementById('openCal').onclick=()=>{ document.getElementById('calendarOverlay').style.display='flex'; renderCalendar(); };
    document.getElementById('calClose').onclick=()=>document.getElementById('calendarOverlay').style.display='none';
    bindCloseX('calendarOverlay','calCloseX'); bindCloseX('bookOverlay','closeBookX'); bindCloseX('completeOverlay','completeCloseX'); bindCloseX('termsOverlay','termsCloseX');
    document.getElementById('bookOverlay').addEventListener('click',e=>{ if(e.target===e.currentTarget) e.currentTarget.style.display='none'; });
    document.getElementById('btnTerms').onclick=()=>document.getElementById('termsOverlay').style.display='flex';
    const openTermsInline = document.getElementById('openTermsInline'); if (openTermsInline) openTermsInline.onclick = () => document.getElementById('termsOverlay').style.display = 'flex';
    document.getElementById('termsClose').onclick=()=>document.getElementById('termsOverlay').style.display='none';
    document.getElementById('closeBook').onclick=()=>document.getElementById('bookOverlay').style.display='none';
    document.getElementById('completeClose').onclick=()=>document.getElementById('completeOverlay').style.display='none';
    document.getElementById('doBook').onclick=()=>doBook();
  });
  
  
  function doBook(){
    // å…¥åŠ›ãƒã‚§ãƒƒã‚¯: è¦ç´„åŒæ„ã¨å¿…é ˆé …ç›®
    if (!document.getElementById('agreeAll').checked){
      showToast('ã”åˆ©ç”¨æ¡ä»¶ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚','err');
      return;
    }
    const name  = document.getElementById('pName').value.trim();
    const phone = document.getElementById('pPhone').value.trim();
    const symptoms = document.getElementById('pSymptoms').value.trim();
    if (!name || !phone){
      showToast('ãŠåå‰ã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚','err');
      return;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºå®š: localStorage ã¾ãŸã¯ id_token ã‹ã‚‰å–å¾—
    let uid = USER_ID || '';
    // id_token ãŒã‚ã‚Œã°ã€ã¾ã  uid ãŒç„¡ã„å ´åˆã«æŠ½å‡ºã—ã¦ä¿å­˜
    if (!uid && ID_TOKEN){
      const sub = extractSubFromIdToken(ID_TOKEN);
      if (sub){
        uid = sub;
        USER_ID = sub;
        try { localStorage.setItem('LINE_UID', sub); } catch {}
      }
    }
    // id_token ã‚‚ uid ã‚‚ç„¡ã„å ´åˆã¯é€£æºå¾…ã¡
    if (!uid && !ID_TOKEN){
      showToast('LINEé€£æºä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚','err');
      return;
    }

    // äºˆç´„å‡¦ç†é–‹å§‹: ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
    setBtnLoading('doBook', true);
    const iso = fmtISO(currentDate);
    const staff = pending.staff;
    const time  = pending.time;
    const payload = { date: iso, startTime: time, staff, patientName: name, email:'', phone, symptoms };

    // æˆåŠŸãƒãƒ³ãƒ‰ãƒ©
    const handleSuccess = (res) => {
      setBtnLoading('doBook', false);
      const okFlag = res?.ok ?? res?.success;
      if (!okFlag){
        showToast(res?.message || 'å¤±æ•—ã—ã¾ã—ãŸ','err');
        return;
      }
      const sched = res.schedule || res;
      schedule = sched;
      renderTable();
      document.getElementById('bookOverlay').style.display = 'none';

      // å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’ç”Ÿæˆ
      const endTime = pending.end;
      const fee     = FEES[pending.staff] || 0;
      const body    = document.getElementById('completeBody');
      body.innerHTML = [
        '<div class="rowline">æ—¥ä»˜ï¼š'+fmtJP(currentDate)+'</div>',
        '<div class="rowline">æ™‚é–“ï¼š'+pending.time+'ã€œ'+endTime+'</div>',
        '<div class="rowline">æ‹…å½“ï¼š'+pending.staff+'</div>',
        '<div class="rowline">æ–™é‡‘ï¼š'+fee.toLocaleString()+'å††</div>',
        '<div class="rowline">ãŠåå‰ï¼š'+name+'</div>',
        phone ? '<div class="rowline">é›»è©±ï¼š'+phone+'</div>' : '',
        symptoms ? '<div class="rowline">ç—‡çŠ¶ï¼š'+symptoms.replace(/</g,'&lt;')+'</div>' : ''
      ].join('');
      document.getElementById('completeOverlay').style.display = 'flex';
    };
    // å¤±æ•—ãƒãƒ³ãƒ‰ãƒ©
    const handleError = (e) => {
      setBtnLoading('doBook', false);
      showToast('ã‚¨ãƒ©ãƒ¼: '+e.message, 'err');
    };

    // uid ãŒç„¡ã„å ´åˆã¯ id_token ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼ã—ã¦äºˆç´„
    if (!uid){
      google.script.run
        .withSuccessHandler((r) => handleSuccess(r?.success !== undefined ? { ok: r.success, schedule: r.schedule } : r))
        .withFailureHandler(handleError)
        .createBookingWithToken(payload, ID_TOKEN);
      return;
    }

    // uid ãŒåˆ¤æ˜ã—ã¦ã„ã‚‹å ´åˆã¯é€šå¸¸ã®äºˆç´„å‡¦ç†
    google.script.run
      .withSuccessHandler((r) => handleSuccess(r?.success !== undefined ? { ok: r.success, schedule: r.schedule } : r))
      .withFailureHandler(handleError)
      .createBooking(iso, time, staff, name, '', phone, symptoms, uid);
  }
  
  
  
  /* Calendar rendering */
  let calendarMonth=new Date();
  function renderCalendar(){
    const y=calendarMonth.getFullYear(), m=calendarMonth.getMonth();
    const grid=document.getElementById('calGrid'); document.getElementById('calTitle').textContent=y+'å¹´'+('0'+(m+1)).slice(-2)+'æœˆ'; grid.innerHTML='';
    ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{ const h=document.createElement('div'); h.className='cal-cell cal-dow'; h.textContent=w; grid.appendChild(h); });
    const first=new Date(y,m,1).getDay();
    for(let i=0;i<first;i++){ const s=document.createElement('div'); s.className='cal-cell is-disabled'; grid.appendChild(s); }
    const last=new Date(y,m+1,0).getDate(); const tISO = fmtISO(new Date()); const curISO = fmtISO(currentDate);
    for(let d=1; d<=last; d++){ const dateObj=new Date(y,m,d); const iso=fmtISO(dateObj);
      const cell=document.createElement('button'); cell.className='cal-cell'; cell.textContent=d;
      if (iso<MIN_DATE){ cell.classList.add('is-disabled'); cell.disabled=true; }
      if (iso===tISO) cell.classList.add('is-today'); if (iso===curISO) cell.classList.add('is-selected');
      cell.onclick=()=>{ setDate(dateObj); document.getElementById('calendarOverlay').style.display='none'; load(true); };
      grid.appendChild(cell);
    }
    document.getElementById('calPrev').onclick=()=>{ calendarMonth.setMonth(calendarMonth.getMonth()-1); renderCalendar(); };
    document.getElementById('calNext').onclick=()=>{ calendarMonth.setMonth(calendarMonth.getMonth()+1); renderCalendar(); };
  }
  </script>
  </body></html>