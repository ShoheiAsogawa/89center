<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>89CENTER ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  /* æ‚£è€…UIã¨åŒã˜ãƒˆãƒ¼ã‚¯ãƒ³ */
  --bg:#f7f9fc; --card:#ffffff; --card-2:#f3f4f6; --text:#111827;
  --muted:#6b7280; --border:#e5e7eb; --primary:#2563eb;
  --orange:#fb923c; --orange-dark:#f97316; --danger:#ef4444; --gray:#e5e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
.container{max-width:1000px;margin:0 auto;padding:12px}

/* header */
header{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 0;position:relative}
h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.02em}
.hdr-right{position:absolute;right:0;top:0;display:flex;gap:8px}

/* buttonsï¼ˆæ‚£è€…UIã¨åŒã˜ã‚¹ãƒ”ãƒŠãƒ¼ä»•æ§˜ï¼‰ */
.btn{border:1px solid var(--border);background:#fff;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .06s ease,filter .12s ease,background-color .12s ease; position:relative}
.btn:active{transform:translateY(1px);filter:brightness(.92)}
.btn-primary{background:var(--primary);color:#fff;border-color:transparent}
.btn-orange{background:var(--orange);border-color:transparent;color:#fff;font-weight:800}
.btn-orange:active{background:var(--orange-dark)}
.btn-danger{background:var(--danger);color:#fff;border-color:transparent}
.btn .btn-label{pointer-events:none}
.btn .spinner{display:none;width:16px;height:16px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);animation:btnspin .8s linear infinite}
.btn.is-loading .spinner{display:block}
.btn.is-loading .btn-label{visibility:hidden}
.btn.is-loading,.btn:disabled{pointer-events:none;opacity:.9;filter:brightness(.95)}
@keyframes btnspin{to{transform:translate(-50%,-50%) rotate(360deg)}}

/* date pill */
.datebar{display:flex;align-items:center;justify-content:center;margin:8px 0 12px}
.date-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:16px;background:#fff;font-weight:700}
.date-pill button{border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer}

/* legend */
.legend{display:flex;align-items:center;justify-content:center;gap:14px;margin:6px 0 10px}
.legend .chip{display:inline-flex;align-items:center;gap:8px}
.legend .dot{width:16px;height:16px;border-radius:6px;border:1px solid var(--border)}
.legend .dot.booked{background:var(--orange);border-color:transparent}
.legend .dot.blocked{background:var(--gray)}

/* grid */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.grid{overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
table{border-collapse:separate;border-spacing:0;width:100%}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
th:first-child,td:first-child{position:sticky;left:0;background:#fff;z-index:3}
th:first-child{z-index:4}
thead th{position:sticky;top:0;z-index:5;background:var(--card-2);font-weight:700}
th,td{padding:8px;min-width:90px;text-align:center}
td.time{background:var(--card-2);font-weight:700;min-width:84px}
td.available{background:#fff;cursor:pointer}
td.blocked{background:var(--gray);color:#374151}
td.booked{background:var(--orange);color:#fff;font-weight:900}
.cell-label{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* overlays & modals */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40;padding:16px}
.modal{position:relative;width:min(92vw,560px);background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.12)}
.modal h2{margin:0 0 12px}
.modal-close{position:absolute;right:8px;top:8px;width:34px;height:34px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;line-height:1;font-weight:900}
.row{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
.field{display:flex;flex-direction:column;gap:6px}
.input,.select,.textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff}
.textarea{min-height:96px;resize:vertical}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* calendar popup */
.cal-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 10px;position:sticky;top:0;background:#fff;z-index:2;padding-bottom:6px}
.cal-nav{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:700}
.cal-title{font-weight:700;font-size:16px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;width:100%}
.cal-cell{height:42px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600}
.cal-dow{background:var(--card-2);color:#4b5563;border-style:dashed;height:36px;font-weight:700}
.is-today{outline:2px solid var(--primary);outline-offset:2px}
.is-selected{background:var(--primary);color:#fff;border-color:transparent}

/* page loading */
.loading-overlay{position:fixed;inset:0;background:rgba(55,65,81,.9);display:none;align-items:center;justify-content:center;z-index:70}
.loading-box{text-align:center;color:#fff}
.loading-title{font-weight:800;font-size:20px;letter-spacing:.08em;display:flex;align-items:center;justify-content:center;gap:8px}
.loading-dot{display:inline-block;min-width:24px;text-align:left;font-weight:900}
.loading-sub{margin-top:10px;font-weight:700;opacity:.95}

/* === Patient UI ã¨åŒã˜ãƒœã‚¿ãƒ³è¡¨ç¾ãƒ»ã‚¢ãƒ‹ãƒ¡ === */
button { appearance:none; -webkit-appearance:none; }

.modal .btn,
.overlay .btn { 
  position: relative;
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 700;
  cursor: pointer;
  transition: transform .06s ease, filter .12s ease, background-color .12s ease;
}
.modal .btn:active,
.overlay .btn:active { transform: translateY(1px); filter: brightness(.92); }

/* ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆæ‚£è€…UIæº–æ‹ ï¼‰ */
.modal .btn-orange,
.overlay .btn-orange {
  background: var(--orange);
  color: #fff;
  border-color: transparent;
}
.modal .btn-orange:active,
.overlay .btn-orange:active { background: var(--orange-dark); }

/* ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆæ‚£è€…UIã¨åŒã˜ï¼‰ */
.modal .btn .btn-label,
.overlay .btn .btn-label { pointer-events:none; }
.modal .btn .spinner,
.overlay .btn .spinner {
  display:none;width:16px;height:16px;border:2px solid currentColor;border-top-color:transparent;
  border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  animation:btnspin .8s linear infinite;
}
.modal .btn.is-loading .spinner,
.overlay .btn.is-loading .spinner { display:block; }
.modal .btn.is-loading .btn-label,
.overlay .btn.is-loading .btn-label { visibility:hidden; }
.modal .btn.is-loading,
.overlay .btn.is-loading { pointer-events:none; opacity:.92; filter:brightness(.95); }

@keyframes btnspin { to { transform:translate(-50%,-50%) rotate(360deg); } }

</style>
</head><body>
<div class="container">
  <header>
    <h1>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div class="hdr-right">
      <button class="btn" id="openBlockRange"><span class="btn-label">äºˆç´„æ ã‚’ãƒ–ãƒ­ãƒƒã‚¯</span><span class="spinner" aria-hidden="true"></span></button>
    </div>
  </header>

  <div class="datebar">
    <div class="date-pill">
      <button id="openCal" aria-label="æ—¥ä»˜é¸æŠ">ğŸ“…</button>
      <div id="dateLabelMain"></div>
    </div>
  </div>

  <div class="legend">
    <span class="chip"><i class="dot booked"></i><span class="caption">äºˆç´„ï¼ˆæ‚£è€…åè¡¨ç¤ºï¼‰</span></span>
    <span class="chip"><i class="dot blocked"></i><span class="caption">ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆç†ç”±è¡¨ç¤ºï¼‰</span></span>
    <span class="caption">(60åˆ†æ )</span>
  </div>

  <div class="card grid"><table id="table">
    <thead><tr><th style="min-width:88px">æ™‚é–“</th><th>éº»ç”Ÿå·</th><th>å²¡é‡</th><th>å €æ±Ÿ</th><th>æ¾ç”°</th><th>å±±å£</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table></div>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="loading-title">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ <span class="loading-dot" id="loadingDots">ãƒ»</span></div>
    <div class="loading-sub">89CENTER</div>
  </div>
</div>

<!-- äºˆç´„è©³ç´° -->
<div class="overlay" id="detailOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="detailCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>äºˆç´„è©³ç´°</h2>
    <div id="detailBody" class="caption"></div>
    <div class="row">
      <div class="field"><label>ç®¡ç†ãƒ¡ãƒ¢ï¼ˆè©²å½“ã‚»ãƒ«ã®Noteã«ä¿å­˜ï¼‰</label><textarea id="adminMemo" class="textarea" placeholder="ã‚¹ã‚¿ãƒƒãƒ•ã«å…±æœ‰ã—ãŸã„æ³¨æ„ç‚¹ãªã©"></textarea></div>
    </div>
    <div class="actions">
      <button class="btn" id="detailClose">é–‰ã˜ã‚‹</button>
      <button class="btn" id="editBtn">åŸºæœ¬æƒ…å ±ã‚’ç·¨é›†</button>
      <button class="btn-danger" id="doCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ç·¨é›† -->
<div class="overlay" id="editOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="editCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>äºˆç´„ã®ç·¨é›†</h2>
    <div class="row">
      <div class="field"><label>æ‚£è€…å</label><input id="editName" class="input"></div>
      <div class="field"><label>é›»è©±</label><input id="editPhone" class="input"></div>
      <div class="field"><label>ãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰</label><input id="editEmail" class="input"></div>
    </div>
    <div class="field"><label>ç—‡çŠ¶ï¼ˆä»»æ„ï¼‰</label><textarea id="editSymptoms" class="textarea"></textarea></div>
    <div class="field"><label>ç®¡ç†ãƒ¡ãƒ¢</label><textarea id="editMemo" class="textarea"></textarea></div>
    <div class="actions">
      <button class="btn" onclick="document.getElementById('editOverlay').style.display='none'">é–‰ã˜ã‚‹</button>
      <button class="btn-orange" id="editSave"><span class="btn-label">ä¿å­˜</span><span class="spinner" aria-hidden="true"></span></button>
    </div>
  </div>
</div>

<!-- ã‚»ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="overlay" id="chooseOverlay" role="dialog" aria-modal="true">
  <div class="modal" style="text-align:center">
    <button class="modal-close" id="chooseCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>ã“ã®ã‚»ãƒ«ã§ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h2>
    <div class="actions" style="gap:12px;justify-content:center">
      <button class="btn" id="chooseBlock">ãƒ–ãƒ­ãƒƒã‚¯</button>
      <!-- â˜…ã“ã“ã‚’æ‚£è€…UIã¨åŒã˜ã‚¹ãƒ”ãƒŠãƒ¼ä»˜ããƒœã‚¿ãƒ³ã« -->
<button class="btn btn-orange" id="chooseCreate">
  <span class="btn-label">äºˆç´„ã‚’ä½œæˆ</span><span class="spinner" aria-hidden="true"></span>
</button>

    </div>
    <div class="actions"><button class="btn" id="chooseClose">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<!-- å˜æ ãƒ–ãƒ­ãƒƒã‚¯ -->
<div class="overlay" id="blockOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="blockCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šï¼ˆå˜æ ï¼‰</h2>
    <div class="row">
      <div class="field"><label>ã‚¹ã‚¿ãƒƒãƒ•</label>
        <select id="blockStaff" class="select"><option>éº»ç”Ÿå·</option><option>å²¡é‡</option><option>å €æ±Ÿ</option><option>æ¾ç”°</option><option>å±±å£</option></select></div>
      <div class="field"><label>æ™‚åˆ»</label><input id="blockTime" class="input" readonly></div>
    </div>
    <div class="field"><label>ç†ç”±ï¼ˆä»»æ„ãƒ»ç®¡ç†è€…ã®ã¿ï¼‰</label><input id="blockReason" class="input" placeholder="ä¾‹ï¼šå‡ºå¼µãƒ»æº–å‚™ç­‰"></div>
    <div class="actions">
      <button class="btn" id="blockClose">é–‰ã˜ã‚‹</button>
      <button class="btn" id="blockOff">è§£é™¤</button>
      <button class="btn btn-orange" id="blockOn">
  <span class="btn-label">ãƒ–ãƒ­ãƒƒã‚¯</span><span class="spinner" aria-hidden="true"></span>
</button>

    </div>
  </div>
</div>

<!-- äºˆç´„ä½œæˆ -->
<div class="overlay" id="createOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="createCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>äºˆç´„ã‚’ä½œæˆ</h2>
    <div class="row">
      <div class="field"><label>ã‚¹ã‚¿ãƒƒãƒ•</label><select id="createStaff" class="select"><option>éº»ç”Ÿå·</option><option>å²¡é‡</option><option>å €æ±Ÿ</option><option>æ¾ç”°</option><option>å±±å£</option></select></div>
      <div class="field"><label>é–‹å§‹æ™‚åˆ»ï¼ˆ60åˆ†ï¼‰</label><select id="createTime" class="select"></select></div>
    </div>
    <div class="row">
      <div class="field"><label>æ‚£è€…å</label><input id="createName" class="input"></div>
      <div class="field"><label>é›»è©±</label><input id="createPhone" class="input"></div>
      <div class="field"><label>ãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰</label><input id="createEmail" class="input"></div>
    </div>
    <div class="field"><label>ç—‡çŠ¶ï¼ˆä»»æ„ï¼‰</label><textarea id="createSymptoms" class="textarea"></textarea></div>
    <div class="field"><label>ç®¡ç†ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="createMemo" class="textarea"></textarea></div>
    <div class="actions">
      <button class="btn" id="createClose">é–‰ã˜ã‚‹</button>
      <button class="btn btn-orange" id="createSubmit">
  <span class="btn-label">ç™»éŒ²</span><span class="spinner" aria-hidden="true"></span></button>

    </div>
  </div>
</div>

<!-- ç¯„å›²ãƒ–ãƒ­ãƒƒã‚¯ -->
<div class="overlay" id="blockRangeOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="blockRangeCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2>äºˆç´„æ ã‚’ãƒ–ãƒ­ãƒƒã‚¯</h2>
    <div class="row">
      <div class="field"><label>ã‚¹ã‚¿ãƒƒãƒ•</label><select id="brStaff" class="select"><option>éº»ç”Ÿå·</option><option>å²¡é‡</option><option>å €æ±Ÿ</option><option>æ¾ç”°</option><option>å±±å£</option></select></div>
      <div class="field"><label>æ—¥ä»˜</label><input id="brDate" type="date" class="input"></div>
    </div>
    <div class="row">
      <div class="field"><label>é–‹å§‹</label><select id="brStart" class="select"></select></div>
      <div class="field"><label>çµ‚äº†</label><select id="brEnd" class="select"></select></div>
    </div>
    <div class="field"><label>ç†ç”±ï¼ˆä»»æ„ï¼‰</label><input id="brReason" class="input" placeholder="ä¾‹ï¼šä¼šè­°/å‡ºå¼µ/ãƒ¡ãƒ³ãƒ†ç­‰"></div>
    <div class="actions">
      <button class="btn" id="blockRangeClose">é–‰ã˜ã‚‹</button>
      <button class="btn btn-orange" id="blockRangeDo">
  <span class="btn-label">ãƒ–ãƒ­ãƒƒã‚¯</span><span class="spinner" aria-hidden="true"></span>
</button>

    </div>
  </div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="overlay" id="calendarOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="modal-close" id="calCloseX" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <div class="cal-head">
      <button class="cal-nav" id="calPrev">â€¹</button>
      <div class="cal-title" id="calTitle">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <button class="cal-nav" id="calNext">â€º</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="actions"><button class="btn" id="calClose">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<script>
/* ========== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
function alertToast(msg){ alert(msg); } // ç®¡ç†UIã¯ alert ã§ååˆ†
function dowJP(d){ return ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]; }
function fmtISO(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
function fmtJP(d){ return d.getFullYear()+'å¹´'+('0'+(d.getMonth()+1)).slice(-2)+'æœˆ'+('0'+d.getDate()).slice(-2)+'æ—¥ï¼ˆ'+dowJP(d)+'ï¼‰'; }
let __dotsTimer=null;
function startDots(){ const el=document.getElementById('loadingDots'); if(!el) return; let n=1; el.textContent='ãƒ»'; clearInterval(__dotsTimer); __dotsTimer=setInterval(()=>{ n=(n%3)+1; el.textContent='ãƒ»'.repeat(n); },420); }
function stopDots(){ if(__dotsTimer){ clearInterval(__dotsTimer); __dotsTimer=null; } const el=document.getElementById('loadingDots'); if(el) el.textContent='ãƒ»'; }
function showLoading(v){ const ov=document.getElementById('loadingOverlay'); ov.style.display=v?'flex':'none'; if(v) startDots(); else stopDots(); }
function setBtnLoading(target,on){ const el=typeof target==='string'?document.getElementById(target):target; if(!el) return; if(on){ el.classList.add('is-loading'); el.setAttribute('aria-busy','true'); el.disabled=true; } else { el.classList.remove('is-loading'); el.removeAttribute('aria-busy'); el.disabled=false; }}

/* ========== ç”»é¢çŠ¶æ…‹ ========== */
const STAFF=['éº»ç”Ÿå·','å²¡é‡','å €æ±Ÿ','æ¾ç”°','å±±å£'];
let currentDate=new Date();
let schedule={}; // schedule[staff][time] = { booked, patientName, bookingId } or { blocked, reason }

/* æ—¥ä»˜è¡¨ç¤º */
function setDate(d){
  currentDate=d;
  const label=document.getElementById('dateLabelMain');
  if(label) label.textContent=fmtJP(currentDate);
}

/* ========== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ========== */
function renderTable(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  const times=[]; for(let h=9;h<21;h++) for(const m of [0,30]) times.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2));

  times.forEach(t=>{
    const tr=document.createElement('tr');
    const timeTd=document.createElement('td'); timeTd.className='time'; timeTd.textContent=t; tr.appendChild(timeTd);

    STAFF.forEach(s=>{
      const td=document.createElement('td');
      const slot=(schedule[s] && schedule[s][t]) || null;

      if(!slot){
        td.className='available';
        td.onclick=()=>openCellAction(t,s);
      }else if(slot.blocked){
        td.className='blocked';
        td.textContent = slot.reason || 'ãƒ–ãƒ­ãƒƒã‚¯';
        td.onclick=()=>openBlockModal(t,s,true,slot.reason||'');
      }else if(slot.booked){
        td.className = 'booked';
        td.textContent = slot.patientName || 'äºˆç´„';
        td.style.fontWeight = '900';
        td.onclick = () => openDetailSmart(slot.startTime || t, s, slot.bookingId || '');
      }else{
        td.className='available';
        td.onclick=()=>openCellAction(t,s);
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ========== ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼ˆç®¡ç†ãƒ•ãƒ©ã‚°ã§éå»ã‚‚å–å¾—ï¼‰ ========== */
function load(withLoader){
  if(withLoader) showLoading(true);
  google.script.run.withSuccessHandler(res=>{
    schedule=res||{}; renderTable(); if(withLoader) showLoading(false);
  }).withFailureHandler(e=>{ if(withLoader) showLoading(false); alert('ã‚¨ãƒ©ãƒ¼: '+e.message); })
    .getSchedule(fmtISO(currentDate), true);
}

/* ========== ã‚»ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ========== */
let pendingCell={time:null,staff:null};
function openCellAction(time,staff){
  pendingCell={time,staff};
  // äºˆç´„ä½œæˆç”¨ã®æ™‚åˆ»ï¼ˆ60åˆ†ç¢ºä¿ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
  const sel=document.getElementById('createTime'); sel.innerHTML='';
  const hh=parseInt(time.slice(0,2)), mm=parseInt(time.slice(3));
  const next=(new Date(0,0,0,hh,mm+30)).toTimeString().slice(0,5);
  const cur=schedule[staff]&&schedule[staff][time], nxt=schedule[staff]&&schedule[staff][next];
  const ok=cur && !cur.booked && !cur.blocked && nxt && !nxt.booked && !nxt.blocked && time<'20:30';
  const opt=document.createElement('option'); opt.value=time; opt.textContent=time+(ok?'':'ï¼ˆä¸å¯ï¼‰'); opt.disabled=!ok; sel.appendChild(opt);

  document.getElementById('createStaff').value=staff;
  document.getElementById('blockStaff').value=staff;
  document.getElementById('blockTime').value=time;

  document.getElementById('chooseOverlay').style.display='flex';
}
document.getElementById('chooseCreate').onclick=()=>{ document.getElementById('chooseOverlay').style.display='none'; document.getElementById('createOverlay').style.display='flex'; };
document.getElementById('chooseBlock').onclick=()=>{ document.getElementById('chooseOverlay').style.display='none'; document.getElementById('blockOverlay').style.display='flex'; };
document.getElementById('chooseClose').onclick=()=>document.getElementById('chooseOverlay').style.display='none';
document.getElementById('chooseCloseX').onclick=()=>document.getElementById('chooseOverlay').style.display='none';

/* ========== äºˆç´„è©³ç´° / ç·¨é›† / ã‚­ãƒ£ãƒ³ã‚»ãƒ« / ãƒ¡ãƒ¢ ========== */
let currentDetail=null;
function openDetail(bookingId){
  if(!bookingId){ alert('ã“ã®äºˆç´„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  google.script.run.withSuccessHandler(d=>{
    currentDetail=d; if(!d){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    document.getElementById('detailBody').innerHTML =
      'æ—¥æ™‚ï¼š'+d.date+' '+d.startTime+'ã€œ'+d.endTime+'<br>'+
      'æ‹…å½“ï¼š'+d.staff+'<br>'+
      'æ°åï¼š'+(d.patientName||'')+'<br>'+
      'é›»è©±ï¼š'+(d.phone||'-')+'ã€€ãƒ¡ãƒ¼ãƒ«ï¼š'+(d.email||'-')+'<br>'+
      'ç—‡çŠ¶ï¼š'+((d.symptoms||'-')+'').replace(/\n/g,'<br>');
    document.getElementById('adminMemo').value=d.adminMemo||'';
    document.getElementById('detailOverlay').style.display='flex';
  }).getBookingDetails(bookingId);
}
document.getElementById('detailClose').onclick=()=>document.getElementById('detailOverlay').style.display='none';
document.getElementById('detailCloseX').onclick=()=>document.getElementById('detailOverlay').style.display='none';

function showDetailModal(d){
  console.log('[showDetailModal] data=', d);
  if(!d){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  currentDetail=d;
  document.getElementById('detailBody').innerHTML =
    'æ—¥æ™‚ï¼š'+d.date+' '+d.startTime+'ã€œ'+d.endTime+'<br>'+
    'æ‹…å½“ï¼š'+d.staff+'<br>'+
    'æ°åï¼š'+(d.patientName||'')+'<br>'+
    'é›»è©±ï¼š'+(d.phone||'-')+'ã€€ãƒ¡ãƒ¼ãƒ«ï¼š'+(d.email||'-')+'<br>'+
    'ç—‡çŠ¶ï¼š'+((d.symptoms||'-')+'').replace(/\n/g,'<br>');
  document.getElementById('adminMemo').value=d.adminMemo||'';
  document.getElementById('detailOverlay').style.display='flex';
}

function openDetailSmart(time, staff, bookingId){
  const iso = fmtISO(currentDate);

  if (bookingId){
    google.script.run
      .withSuccessHandler(d => d ? showDetailModal(d) : tryKey())
      .withFailureHandler(e => alert('å–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message))
      .getBookingDetails(bookingId);
    return;
  }

  tryKey();
  function tryKey(){
    const candidates = [time, stepMin(time,-30)];
    (function next(i){
      if (i >= candidates.length){
        google.script.run.withSuccessHandler(diag => {
          console.log('[diagCell]', diag);
          alert('è©²å½“äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }).diagCell(iso, staff, time);
        return;
      }
      const key = candidates[i];
      google.script.run
        .withSuccessHandler(d => d ? showDetailModal(d) : next(i+1))
        .withFailureHandler(e => alert('å–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message))
        .adminGetBookingByKey(iso, staff, key);  // â† ã“ã“ãŒå­˜åœ¨ã™ã‚‹ã“ã¨
    })(0);
  }
}


function handleAdminCellClick(staff, time){
  const iso = document.querySelector('#dateLabel').dataset.iso || // ç”»é¢ã§ä½¿ã£ã¦ã‚‹ISO
              new Date().toISOString().slice(0,10);

  const cell = (window.schedule && window.schedule[staff] && window.schedule[staff][time]) || {};
  const id = cell.bookingId || '';

  if (id){
    google.script.run
      .withSuccessHandler(d => d ? showDetailModal(d) : alert('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'))
      .withFailureHandler(e => alert('å–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message))
      .getBookingDetails(id);
  } else {
    // 9:30ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚9:00-10:00ã®äºˆç´„ã‚’æ‹¾ãˆã‚‹
    google.script.run
      .withSuccessHandler(d => d ? showDetailModal(d) : alert('è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'))
      .withFailureHandler(e => alert('å–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message))
      .adminFindFirstByTime(iso, time);
  }
}

function stepMin(hhmm, delta){
  const m = hhmm.match(/^(\d{2}):(\d{2})$/); if (!m) return hhmm;
  const dt = new Date(2000,0,1, +m[1], +m[2]); dt.setMinutes(dt.getMinutes()+delta);
  return ('0'+dt.getHours()).slice(-2)+':'+('0'+dt.getMinutes()).slice(-2);
}


// åˆ†ã‚·ãƒ•ãƒˆï¼ˆ"09:30" â†’ stepMin(...,-30) ã§ "09:00"ï¼‰
function stepMin(hhmm, delta){
  const m = hhmm.match(/^(\d{2}):(\d{2})$/); if(!m) return hhmm;
  const base = new Date(2000,0,1, parseInt(m[1],10), parseInt(m[2],10));
  base.setMinutes(base.getMinutes()+delta);
  const h=('0'+base.getHours()).slice(-2), n=('0'+base.getMinutes()).slice(-2);
  return `${h}:${n}`;
}





// ç®¡ç†ãƒ¡ãƒ¢ï¼ˆNoteï¼‰å³ä¿å­˜
document.getElementById('adminMemo').addEventListener('change', ()=>{
  if(!currentDetail) return;
  const memo=document.getElementById('adminMemo').value;
  google.script.run.withSuccessHandler(res=>{
    schedule=res.schedule||schedule; renderTable();
  }).adminUpdateBooking(currentDetail.bookingId,{adminMemo:memo});
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«
document.getElementById('doCancel').onclick=()=>{
  if(!currentDetail) return;
  if(!confirm('ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  google.script.run.withSuccessHandler(res=>{
    alert(res.message||'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
    document.getElementById('detailOverlay').style.display='none';
    schedule=res.schedule||schedule; renderTable();
  }).adminCancelBooking(currentDetail.bookingId);
};

// ç·¨é›†
document.getElementById('editBtn').onclick=()=>{
  if(!currentDetail) return;
  document.getElementById('editName').value=currentDetail.patientName||'';
  document.getElementById('editPhone').value=currentDetail.phone||'';
  document.getElementById('editEmail').value=currentDetail.email||'';
  document.getElementById('editSymptoms').value=currentDetail.symptoms||'';
  document.getElementById('editMemo').value=currentDetail.adminMemo||'';
  document.getElementById('editOverlay').style.display='flex';
};
document.getElementById('editCloseX').onclick=()=>document.getElementById('editOverlay').style.display='none';
document.getElementById('editSave').onclick=()=>{
  if(!currentDetail) return;
  setBtnLoading('editSave',true);
  const payload={
    patientName:document.getElementById('editName').value.trim(),
    phone:document.getElementById('editPhone').value.trim(),
    email:document.getElementById('editEmail').value.trim(),
    symptoms:document.getElementById('editSymptoms').value.trim(),
    adminMemo:document.getElementById('editMemo').value.trim()
  };
  google.script.run.withSuccessHandler(res=>{
    setBtnLoading('editSave',false);
    alert(res.message||'ä¿å­˜ã—ã¾ã—ãŸ');
    document.getElementById('editOverlay').style.display='none';
    document.getElementById('detailOverlay').style.display='none';
    schedule=res.schedule||schedule; renderTable();
  }).withFailureHandler(e=>{ setBtnLoading('editSave',false); alert('ã‚¨ãƒ©ãƒ¼: '+e.message); })
    .adminUpdateBooking(currentDetail.bookingId,payload);
};

/* ========== å˜æ ãƒ–ãƒ­ãƒƒã‚¯ ON/OFF ========== */
function openBlockModal(t,s,exists,reason){
  document.getElementById('blockStaff').value=s;
  document.getElementById('blockTime').value=t;
  document.getElementById('blockReason').value=reason||'';
  document.getElementById('blockOverlay').style.display='flex';
}
document.getElementById('blockOn').onclick=()=>{
  const iso=fmtISO(currentDate), s=document.getElementById('blockStaff').value, t=document.getElementById('blockTime').value, r=document.getElementById('blockReason').value;
  setBtnLoading('blockOn',true);
  google.script.run.withSuccessHandler(res=>{
    setBtnLoading('blockOn',false);
    schedule=res.schedule||schedule; renderTable(); document.getElementById('blockOverlay').style.display='none';
  }).setBlock(iso,t,s,r,true);
};
document.getElementById('blockOff').onclick=()=>{
  const iso=fmtISO(currentDate), s=document.getElementById('blockStaff').value, t=document.getElementById('blockTime').value;
  google.script.run.withSuccessHandler(res=>{
    schedule=res.schedule||schedule; renderTable(); document.getElementById('blockOverlay').style.display='none';
  }).setBlock(iso,t,s,'',false);
};
document.getElementById('blockClose').onclick=()=>document.getElementById('blockOverlay').style.display='none';
document.getElementById('blockCloseX').onclick=()=>document.getElementById('blockOverlay').style.display='none';

/* ========== äºˆç´„ä½œæˆï¼ˆç®¡ç†ï¼‰ ========== */
document.getElementById('createSubmit').onclick=()=>{
  const staff=document.getElementById('createStaff').value;
  const time=document.getElementById('createTime').value;
  const name=document.getElementById('createName').value.trim();
  const phone=document.getElementById('createPhone').value.trim();
  const email=document.getElementById('createEmail').value.trim();
  const symptoms=document.getElementById('createSymptoms').value.trim();
  const adminMemo=document.getElementById('createMemo').value.trim();
  if(!name||!phone){ alert('æ°åã¨é›»è©±ã¯å¿…é ˆã§ã™ã€‚'); return; }
  setBtnLoading('createSubmit',true);
  google.script.run.withSuccessHandler(res=>{
    setBtnLoading('createSubmit',false);
    if(!res.success){ alert(res.message||'ç™»éŒ²å¤±æ•—'); return; }
    schedule=res.schedule||schedule; renderTable(); document.getElementById('createOverlay').style.display='none';
  }).adminCreateBooking(fmtISO(currentDate), time, staff, name, email, phone, symptoms, adminMemo);
};
document.getElementById('createClose').onclick=()=>document.getElementById('createOverlay').style.display='none';
document.getElementById('createCloseX').onclick=()=>document.getElementById('createOverlay').style.display='none';

/* ========== ç¯„å›²ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå³ä¸Šï¼‰ ========== */
function fillTimeOptions(sel, start='09:00', end='21:00', step=30){
  sel.innerHTML=''; let [h,m]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  while(h<eh || (h===eh && m<=em)){
    const t=('0'+h).slice(-2)+':'+('0'+m).slice(-2);
    const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o);
    m+=step; if(m>=60){ h++; m-=60; }
  }
}
document.getElementById('openBlockRange').onclick=()=>{
  document.getElementById('brDate').value=fmtISO(currentDate);
  fillTimeOptions(document.getElementById('brStart'),'09:00','20:30');
  fillTimeOptions(document.getElementById('brEnd'),'09:30','21:00');
  document.getElementById('blockRangeOverlay').style.display='flex';
};
document.getElementById('blockRangeClose').onclick=()=>document.getElementById('blockRangeOverlay').style.display='none';
document.getElementById('blockRangeCloseX').onclick=()=>document.getElementById('blockRangeOverlay').style.display='none';
document.getElementById('blockRangeDo').onclick=()=>{
  const staff=document.getElementById('brStaff').value;
  const date=document.getElementById('brDate').value;
  const start=document.getElementById('brStart').value;
  const end=document.getElementById('brEnd').value;
  const reason=document.getElementById('brReason').value;
  if(!date||!start||!end){ alert('æ—¥ä»˜/é–‹å§‹/çµ‚äº†ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if(end<=start){ alert('çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„'); return; }
  setBtnLoading('blockRangeDo',true);
  google.script.run.withSuccessHandler(res=>{
    setBtnLoading('blockRangeDo',false);
    schedule=res.schedule||schedule; renderTable(); document.getElementById('blockRangeOverlay').style.display='none';
  }).withFailureHandler(e=>{
    setBtnLoading('blockRangeDo',false); alert('ã‚¨ãƒ©ãƒ¼: '+e.message);
  }).adminSetBlockRange(date, staff, start, end, reason, true);
};

/* ========== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆéå»æ—¥ã‚‚é¸æŠå¯ï¼‰ ========== */
let calendarMonth=new Date();
function renderCalendar(){
  const y=calendarMonth.getFullYear(), m=calendarMonth.getMonth();
  const grid=document.getElementById('calGrid'); document.getElementById('calTitle').textContent=y+'å¹´'+('0'+(m+1)).slice(-2)+'æœˆ'; grid.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{ const h=document.createElement('div'); h.className='cal-cell cal-dow'; h.textContent=w; grid.appendChild(h); });
  const first=new Date(y,m,1).getDay(); for(let i=0;i<first;i++){ const s=document.createElement('div'); s.className='cal-cell'; s.style.visibility='hidden'; grid.appendChild(s); }
  const last=new Date(y,m+1,0).getDate(); const tISO=fmtISO(new Date()); const curISO=fmtISO(currentDate);
  for(let d=1; d<=last; d++){
    const dateObj=new Date(y,m,d); const iso=fmtISO(dateObj);
    const cell=document.createElement('button'); cell.className='cal-cell'; cell.textContent=d;
    if(iso===tISO) cell.classList.add('is-today'); if(iso===curISO) cell.classList.add('is-selected');
    cell.onclick=()=>{ setDate(dateObj); document.getElementById('calendarOverlay').style.display='none'; load(true); };
    grid.appendChild(cell);
  }
  document.getElementById('calPrev').onclick=()=>{ calendarMonth.setMonth(calendarMonth.getMonth()-1); renderCalendar(); };
  document.getElementById('calNext').onclick=()=>{ calendarMonth.setMonth(calendarMonth.getMonth()+1); renderCalendar(); };
}

function stepMin(hhmm, delta){
  const m = hhmm.match(/^(\d{2}):(\d{2})$/); if(!m) return hhmm;
  const base = new Date(2000,0,1, parseInt(m[1],10), parseInt(m[2],10));
  base.setMinutes(base.getMinutes()+delta);
  const h=('0'+base.getHours()).slice(-2), n=('0'+base.getMinutes()).slice(-2);
  return `${h}:${n}`;
}


/* ========== åˆæœŸåŒ– ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  setDate(new Date());
  load(true);

  // ğŸ“…ã‚’æŠ¼ã—ã¦æ—¥ä»˜é¸æŠ
  document.getElementById('openCal').onclick=()=>{ document.getElementById('calendarOverlay').style.display='flex'; renderCalendar(); };
  document.getElementById('calClose').onclick=()=>document.getElementById('calendarOverlay').style.display='none';
  document.getElementById('calCloseX').onclick=()=>document.getElementById('calendarOverlay').style.display='none';
});
</script>
</body></html>
